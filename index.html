<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¨çˆ¾è¨­è¨ˆå·¥ä½œå®¤ CRM</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'wine': {
                            '50': '#fef2f2',
                            '100': '#fee2e2',
                            '200': '#fecaca',
                            '300': '#fca5a5',
                            '400': '#f87171',
                            '500': '#ef4444',
                            '600': '#dc2626',
                            '700': '#b91c1c',
                            '800': '#991b1b', // Main theme color
                            '900': '#7f1d1d', // Hover color
                            '950': '#450a0a',
                        },
                    }
                },
            }
        }
    </script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .truncate-text { max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .kanban-column { min-width: 300px; height: calc(100vh - 200px); }
        .calendar-day { min-height: 120px; }
        .calendar-day:hover { background-color: #f1f5f9; }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- ===== Main Application Container ===== -->
    <div id="app-container" class="flex h-screen">

        <!-- ===== Left Sidebar ===== -->
        <aside class="w-64 flex-shrink-0 bg-white border-r border-slate-200 flex flex-col no-print">
            <div class="h-28 flex flex-col items-center justify-center border-b border-slate-200 p-4">
                <img src="https://placehold.co/120x120/991b1b/white?text=WD" alt="å¨çˆ¾è¨­è¨ˆå·¥ä½œå®¤ LOGO" class="w-16 h-16 rounded-full mb-2">
                <span class="text-lg font-bold text-slate-700">å¨çˆ¾è¨­è¨ˆ CRM</span>
            </div>
            <nav id="main-nav" class="flex-1 px-4 py-6 space-y-2">
                <a href="#" data-target="dashboard-content" class="nav-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>å„€è¡¨æ¿</a>
                <a href="#" data-target="customers-content" class="nav-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>å®¢æˆ¶ç®¡ç†</a>
                <a href="#" data-target="projects-content" class="nav-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="8" x="3" y="3" rx="2"/><path d="M7 11v4a2 2 0 0 0 2 2h4"/><rect width="8" height="8" x="13" y="13" rx="2"/></svg>å°ˆæ¡ˆç®¡ç†</a>
                <a href="#" data-target="calendar-content" class="nav-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>è¡Œäº‹æ›†</a>
                <a href="#" data-target="billing-content" class="nav-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M12 9v4"/><path d="M12 17h.01"/><path d="M15 2v5h5"/></svg>å¸³å‹™ç®¡ç†</a>
                <a href="#" data-target="reports-content" class="nav-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8a6 6 0 0 0-6 0"/><path d="M12.7 14a6 6 0 0 0-6 0"/><path d="M6.7 20a6 6 0 0 0-6 0"/></svg>å ±è¡¨åˆ†æ</a>
                <a href="#" data-target="settings-content" class="nav-link flex items-center px-4 py-2.5 text-sm font-medium rounded-lg"><svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>è¨­å®š</a>
            </nav>
        </aside>

        <!-- ===== Main Content ===== -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Header -->
            <header class="h-20 bg-white border-b border-slate-200 flex items-center justify-between px-8 no-print">
                <div><h1 id="main-header-title" class="text-2xl font-bold text-slate-800"></h1></div>
                <div class="flex items-center space-x-6">
                    <!-- Action buttons dynamically shown based on tab -->
                    <div id="project-actions" class="hidden"><button id="add-project-btn" class="flex items-center justify-center bg-wine-800 hover:bg-wine-900 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-sm"><svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>æ–°å¢å°ˆæ¡ˆ</button></div>
                    <div id="customer-actions" class="hidden"><button id="add-customer-btn" class="flex items-center justify-center bg-wine-800 hover:bg-wine-900 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-sm"><svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>æ–°å¢å®¢æˆ¶</button></div>
                    <div id="billing-actions" class="hidden"><button id="add-invoice-btn" class="flex items-center justify-center bg-wine-800 hover:bg-wine-900 text-white font-medium py-2 px-4 rounded-lg transition-colors shadow-sm"><svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>æ–°å¢å¸³å‹™</button></div>
                </div>
            </header>
            
            <!-- Content Area -->
            <div class="flex-1 overflow-auto p-8">
                <div id="dashboard-content" class="content-section">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-slate-500 text-sm font-medium">ç¸½å®¢æˆ¶æ•¸</h3><p id="dashboard-customer-count" class="text-3xl font-bold text-wine-800 mt-2">0</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-slate-500 text-sm font-medium">ç‡Ÿæ¥­é¡ (éè‰ç¨¿)</h3><p id="dashboard-revenue" class="text-3xl font-bold text-slate-800 mt-2">$0</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-slate-500 text-sm font-medium">å·²æ”¶å¸³æ¬¾</h3><p id="dashboard-paid" class="text-3xl font-bold text-green-600 mt-2">$0</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-slate-500 text-sm font-medium">æœªæ”¶å¸³æ¬¾</h3><p id="dashboard-unpaid" class="text-3xl font-bold text-wine-800 mt-2">$0</p></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-slate-500 text-sm font-medium">é€²è¡Œä¸­å°ˆæ¡ˆ</h3><p id="dashboard-project-count" class="text-3xl font-bold text-slate-800 mt-2">0</p></div>
                    </div>
                     <div class="mt-8 bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">è¿‘æœŸå‹•æ…‹</h3>
                        <ul id="activity-log" class="space-y-4">
                           <!-- Dynamic content from JS -->
                           <li class="text-center p-4 text-slate-500">æ­£åœ¨è¼‰å…¥å‹•æ…‹...</li>
                        </ul>
                    </div>
                </div>

                <div id="customers-content" class="content-section hidden">
                    <div class="flex justify-between items-center mb-6"><p id="customer-count" class="text-sm text-slate-500"></p></div>
                    <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600"><thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th scope="col" class="px-6 py-3">å…¬å¸ / çµ±ç·¨</th><th scope="col" class="px-6 py-3">è¯çµ¡äºº</th><th scope="col" class="px-6 py-3">é€£çµ¡é›»è©±</th><th scope="col" class="px-6 py-3">åœ°å€</th><th scope="col" class="px-6 py-3">å‚™è¨»</th><th scope="col" class="px-6 py-3 text-center">æ“ä½œ</th></tr></thead><tbody id="customer-list-body"></tbody></table>
                    </div>
                </div>

                <div id="projects-content" class="content-section hidden h-full">
                    <div class="flex space-x-6 h-full overflow-x-auto pb-4">
                        <div class="kanban-column flex-shrink-0 w-1/3 bg-slate-100 rounded-lg flex flex-col"><h3 class="text-md font-bold text-slate-700 p-4 border-b border-slate-200 flex-shrink-0">è¦åŠƒä¸­</h3><div id="planning-column" class="p-4 space-y-4 overflow-y-auto flex-grow"></div></div>
                        <div class="kanban-column flex-shrink-0 w-1/3 bg-slate-100 rounded-lg flex flex-col"><h3 class="text-md font-bold text-slate-700 p-4 border-b border-slate-200 flex-shrink-0">é€²è¡Œä¸­</h3><div id="inprogress-column" class="p-4 space-y-4 overflow-y-auto flex-grow"></div></div>
                        <div class="kanban-column flex-shrink-0 w-1/3 bg-slate-100 rounded-lg flex flex-col"><h3 class="text-md font-bold text-slate-700 p-4 border-b border-slate-200 flex-shrink-0">å·²å®Œæˆ</h3><div id="completed-column" class="p-4 space-y-4 overflow-y-auto flex-grow"></div></div>
                    </div>
                </div>

                <div id="calendar-content" class="content-section hidden bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month-btn" class="p-2 rounded-full hover:bg-slate-200 transition-colors">&lt;</button>
                        <h2 id="month-year-header" class="text-xl font-bold"></h2>
                        <button id="next-month-btn" class="p-2 rounded-full hover:bg-slate-200 transition-colors">&gt;</button>
                    </div>
                    <div class="grid grid-cols-7 gap-px bg-slate-200 border border-slate-200">
                        <div class="text-center font-semibold py-2 bg-slate-50">æ—¥</div><div class="text-center font-semibold py-2 bg-slate-50">ä¸€</div><div class="text-center font-semibold py-2 bg-slate-50">äºŒ</div><div class="text-center font-semibold py-2 bg-slate-50">ä¸‰</div><div class="text-center font-semibold py-2 bg-slate-50">å››</div><div class="text-center font-semibold py-2 bg-slate-50">äº”</div><div class="text-center font-semibold py-2 bg-slate-50">å…­</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-px bg-slate-200"></div>
                </div>

                <div id="billing-content" class="content-section hidden">
                     <div class="flex justify-between items-center mb-6"><p id="invoice-count" class="text-sm text-slate-500"></p></div>
                    <div class="bg-white rounded-lg shadow-md overflow-x-auto">
                        <table class="w-full text-sm text-left text-slate-600">
                            <thead class="text-xs text-slate-700 uppercase bg-slate-50"><tr><th scope="col" class="px-6 py-3">å¸³å–®è™Ÿç¢¼</th><th scope="col" class="px-6 py-3">å®¢æˆ¶ / å°ˆæ¡ˆ</th><th scope="col" class="px-6 py-3">æ—¥æœŸ</th><th scope="col" class="px-6 py-3">ç¸½é‡‘é¡</th><th scope="col" class="px-6 py-3">ç‹€æ…‹</th><th scope="col" class="px-6 py-3 text-center">æ“ä½œ</th></tr></thead>
                            <tbody id="invoice-list-body"></tbody>
                        </table>
                    </div>
                </div>

                <div id="reports-content" class="content-section hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-bold text-slate-800 mb-4">æ¯æœˆç‡Ÿæ¥­é¡è¶¨å‹¢</h3><canvas id="revenue-chart"></canvas></div>
                        <div class="bg-white p-6 rounded-lg shadow-md"><h3 class="text-lg font-bold text-slate-800 mb-4">å®¢æˆ¶è²¢ç»ä½”æ¯”</h3><canvas id="customer-contribution-chart"></canvas></div>
                        <div class="bg-white p-6 rounded-lg shadow-md lg:col-span-2"><h3 class="text-lg font-bold text-slate-800 mb-4">å°ˆæ¡ˆç‹€æ…‹åˆ†ä½ˆ</h3><canvas id="project-status-chart"></canvas></div>
                    </div>
                </div>

                <div id="settings-content" class="content-section hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md max-w-md">
                        <h3 class="text-lg font-bold text-slate-800 mb-4">ç³»çµ±è¨­å®š</h3>
                        <p class="text-slate-600 mb-2">é€™è£¡æ˜¯è¨­å®šé é¢ï¼Œæœªä¾†å¯æ“´å……ç³»çµ±ç›¸é—œè¨­å®šã€‚</p>
                        <div class="mt-4">
                            <p class="text-sm font-medium text-slate-700">æ‚¨çš„ä½¿ç”¨è€… ID (ä¾›å”ä½œåˆ†äº«):</p>
                            <p id="user-id-display" class="text-xs text-slate-500 bg-slate-100 p-2 rounded break-all">è¼‰å…¥ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ===== Modals ===== -->
    <!-- Add/Edit Customer Modal -->
    <div id="customer-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 opacity-0 -translate-y-10"><div class="flex justify-between items-center mb-6"><h3 id="customer-modal-title" class="text-xl font-bold text-slate-800"></h3><button class="modal-close-btn text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button></div><form id="customer-form"><input type="hidden" id="customerId"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="companyName" class="block text-sm font-medium text-slate-700">å…¬å¸åç¨±*</label><input type="text" id="companyName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500" required></div><div><label for="taxId" class="block text-sm font-medium text-slate-700">çµ±ä¸€ç·¨è™Ÿ</label><input type="text" id="taxId" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></div><div><label for="contactPerson" class="block text-sm font-medium text-slate-700">è¯çµ¡äºº*</label><input type="text" id="contactPerson" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500" required></div><div><label for="phone" class="block text-sm font-medium text-slate-700">é€£çµ¡é›»è©±</label><input type="tel" id="phone" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></div><div><label for="fax" class="block text-sm font-medium text-slate-700">å‚³çœŸ</label><input type="tel" id="fax" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></div><div><label for="email" class="block text-sm font-medium text-slate-700">é›»å­éƒµä»¶*</label><input type="email" id="email" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500" required></div><div class="md:col-span-2"><label for="address" class="block text-sm font-medium text-slate-700">åœ°å€</label><input type="text" id="address" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></div><div class="md:col-span-2"><label for="notes" class="block text-sm font-medium text-slate-700">å‚™è¨»</label><textarea id="notes" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></textarea></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" class="modal-cancel-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">å–æ¶ˆ</button><button type="submit" id="customer-modal-submit-btn" class="px-4 py-2 bg-wine-800 text-white rounded-md hover:bg-wine-900"></button></div></form></div></div>
    
    <!-- Add/Edit Project Modal -->
    <div id="project-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 opacity-0 -translate-y-10"><div class="flex justify-between items-center mb-6"><h3 id="project-modal-title" class="text-xl font-bold text-slate-800"></h3><button class="modal-close-btn text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button></div><form id="project-form"><input type="hidden" id="projectId"><div class="space-y-4"><div><label for="projectName" class="block text-sm font-medium text-slate-700">å°ˆæ¡ˆåç¨±*</label><input type="text" id="projectName" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500" required></div><div><label for="projectCustomer" class="block text-sm font-medium text-slate-700">é—œè¯å®¢æˆ¶*</label><select id="projectCustomer" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500" required></select></div><div><label for="projectDeadline" class="block text-sm font-medium text-slate-700">æˆªæ­¢æ—¥æœŸ</label><input type="date" id="projectDeadline" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></div><div><label for="projectStatus" class="block text-sm font-medium text-slate-700">å°ˆæ¡ˆç‹€æ…‹</label><select id="projectStatus" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"><option>è¦åŠƒä¸­</option><option>é€²è¡Œä¸­</option><option>å·²å®Œæˆ</option></select></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" class="modal-cancel-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">å–æ¶ˆ</button><button type="submit" id="project-modal-submit-btn" class="px-4 py-2 bg-wine-800 text-white rounded-md hover:bg-wine-900"></button></div></form></div></div>
    
    <!-- Add/Edit/View Invoice Modal -->
    <div id="invoice-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl opacity-0 -translate-y-10 print-area"><div class="flex justify-between items-center mb-6 p-6 border-b no-print"><h3 id="invoice-modal-title" class="text-xl font-bold text-slate-800"></h3><div><button id="print-invoice-btn" class="text-slate-500 hover:text-slate-800 text-xl p-2 rounded-full hover:bg-slate-100" title="åˆ—å°å¸³å–®">ğŸ–¨ï¸</button><button class="modal-close-btn text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button></div></div><form id="invoice-form" class="max-h-[70vh] overflow-y-auto p-6 pr-2"><input type="hidden" id="invoiceId"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"><div><label for="invoiceCustomer" class="block text-sm font-medium text-slate-700">å®¢æˆ¶*</label><select id="invoiceCustomer" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500" required></select></div><div><label for="invoiceProject" class="block text-sm font-medium text-slate-700">é—œè¯å°ˆæ¡ˆ</label><select id="invoiceProject" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></select></div><div><label for="invoiceNumber" class="block text-sm font-medium text-slate-700">å¸³å–®è™Ÿç¢¼*</label><input type="text" id="invoiceNumber" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500" required></div><div><label for="invoiceIssueDate" class="block text-sm font-medium text-slate-700">é–‹ç«‹æ—¥æœŸ</label><input type="date" id="invoiceIssueDate" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></div><div><label for="invoiceStatus" class="block text-sm font-medium text-slate-700">ç‹€æ…‹</label><select id="invoiceStatus" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"><option>è‰ç¨¿</option><option>å·²å‚³é€</option><option>å·²ä»˜æ¬¾</option><option>å·²é€¾æœŸ</option></select></div><div><label for="invoiceCloseDate" class="block text-sm font-medium text-slate-700">çµæ¡ˆæ—¥æœŸ</label><input type="date" id="invoiceCloseDate" class="mt-1 block w-full px-3 py-2 bg-slate-100 border border-slate-300 rounded-md shadow-sm" readonly></div></div><div class="mb-4"><h4 class="text-lg font-semibold text-slate-800 mb-2">æœå‹™é …ç›®</h4><div id="invoice-items-container" class="space-y-2"></div><button type="button" id="add-invoice-item-btn" class="mt-2 text-sm text-wine-700 font-semibold hover:text-wine-900 no-print">+ æ–°å¢é …ç›®</button></div><div class="flex justify-end mt-6 border-t pt-4"><div class="w-full md:w-1/3 text-right"><div class="flex justify-between"><span class="font-semibold text-slate-600">ç¸½è¨ˆ:</span><span id="invoice-total-amount" class="font-bold text-xl text-slate-800">$0.00</span></div></div></div><div class="mt-8 flex justify-end space-x-3 no-print" id="invoice-modal-footer"><button type="button" class="modal-cancel-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">å–æ¶ˆ</button><button type="submit" id="invoice-modal-submit-btn" class="px-4 py-2 bg-wine-800 text-white rounded-md hover:bg-wine-900"></button></div></form></div></div>
    
    <!-- Add/Edit Calendar Event Modal -->
    <div id="event-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none"><div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-lg p-6 opacity-0 -translate-y-10"><div class="flex justify-between items-center mb-6"><h3 id="event-modal-title" class="text-xl font-bold text-slate-800"></h3><button class="modal-close-btn text-slate-500 hover:text-slate-800 text-2xl leading-none">&times;</button></div><form id="event-form"><input type="hidden" id="eventId"><input type="hidden" id="eventDate"><div class="space-y-4"><div><label for="eventTitle" class="block text-sm font-medium text-slate-700">äº‹ä»¶æ¨™é¡Œ*</label><input type="text" id="eventTitle" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500" required></div><div><label for="eventCustomer" class="block text-sm font-medium text-slate-700">é—œè¯å®¢æˆ¶</label><select id="eventCustomer" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></select></div><div><label for="eventProject" class="block text-sm font-medium text-slate-700">é—œè¯å°ˆæ¡ˆ</label><select id="eventProject" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></select></div><div><label for="eventNotes" class="block text-sm font-medium text-slate-700">å‚™è¨»</label><textarea id="eventNotes" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm focus:outline-none focus:ring-wine-500 focus:border-wine-500"></textarea></div></div><div class="mt-6 flex justify-end space-x-3"><button type="button" id="event-modal-delete-btn" class="hidden px-4 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 mr-auto">åˆªé™¤</button><button type="button" class="modal-cancel-btn px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">å–æ¶ˆ</button><button type="submit" id="event-modal-submit-btn" class="px-4 py-2 bg-wine-800 text-white rounded-md hover:bg-wine-900">å„²å­˜</button></div></form></div></div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal-backdrop fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 opacity-0 pointer-events-none">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-sm p-6 opacity-0 -translate-y-10">
            <h3 id="confirm-modal-title" class="text-lg font-bold text-slate-800 mb-4">ç¢ºèªæ“ä½œ</h3>
            <p id="confirm-modal-body" class="text-slate-600 mb-6">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-slate-200 text-slate-800 rounded-md hover:bg-slate-300">å–æ¶ˆ</button>
                <button id="confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">ç¢ºå®šåˆªé™¤</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {
            // --- 1. FIREBASE INITIALIZATION & AUTH ---
            const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            let userId = null;
            let isAuthReady = false;

            // Sign in the user
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("User signed in with UID:", userId);
                    document.getElementById('user-id-display').textContent = userId;
                    // Once authenticated, initialize data listeners
                    initDataListeners();
                    renderCalendar(); // Initial calendar render
                } else {
                    console.log("User is signed out.");
                }
            });

            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                document.getElementById('user-id-display').textContent = 'èªè­‰å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†ã€‚';
            }


            // --- 2. GLOBAL STATE & REFERENCES ---
            let currentOpenModal = null;
            let currentDeleteAction = null; 
            let revenueChart, customerChart, projectChart;
            let currentDate = new Date();

            // CORRECTED: Using the standard public path for shared data
            const collections = {
                customers: collection(db, 'artifacts', appId, 'public', 'data', 'customers'),
                projects: collection(db, 'artifacts', appId, 'public', 'data', 'projects'),
                invoices: collection(db, 'artifacts', appId, 'public', 'data', 'invoices'),
                events: collection(db, 'artifacts', appId, 'public', 'data', 'calendar_events'),
                activities: collection(db, 'artifacts', appId, 'public', 'data', 'activity_logs')
            };

            // --- 3. DOM ELEMENT REFERENCES ---
            const DOMElements = {
                mainHeader: document.getElementById('main-header-title'),
                navLinks: document.querySelectorAll('.nav-link'),
                contentSections: document.querySelectorAll('.content-section'),
                actionButtons: {
                    customer: document.getElementById('customer-actions'),
                    project: document.getElementById('project-actions'),
                    billing: document.getElementById('billing-actions'),
                },
                addCustomerBtn: document.getElementById('add-customer-btn'),
                addProjectBtn: document.getElementById('add-project-btn'),
                addInvoiceBtn: document.getElementById('add-invoice-btn'),
                customerListBody: document.getElementById('customer-list-body'),
                invoiceListBody: document.getElementById('invoice-list-body'),
                kanban: {
                    planning: document.getElementById('planning-column'),
                    inprogress: document.getElementById('inprogress-column'),
                    completed: document.getElementById('completed-column'),
                },
                customerModal: {
                    el: document.getElementById('customer-modal'),
                    title: document.getElementById('customer-modal-title'),
                    form: document.getElementById('customer-form'),
                    submitBtn: document.getElementById('customer-modal-submit-btn'),
                },
                projectModal: {
                    el: document.getElementById('project-modal'),
                    title: document.getElementById('project-modal-title'),
                    form: document.getElementById('project-form'),
                    submitBtn: document.getElementById('project-modal-submit-btn'),
                },
                 invoiceModal: {
                    el: document.getElementById('invoice-modal'),
                    title: document.getElementById('invoice-modal-title'),
                    form: document.getElementById('invoice-form'),
                    submitBtn: document.getElementById('invoice-modal-submit-btn'),
                    footer: document.getElementById('invoice-modal-footer'),
                },
                eventModal: {
                    el: document.getElementById('event-modal'),
                    title: document.getElementById('event-modal-title'),
                    form: document.getElementById('event-form'),
                    submitBtn: document.getElementById('event-modal-submit-btn'),
                    deleteBtn: document.getElementById('event-modal-delete-btn'),
                },
                confirmModal: {
                    el: document.getElementById('confirm-modal'),
                    title: document.getElementById('confirm-modal-title'),
                    body: document.getElementById('confirm-modal-body'),
                    okBtn: document.getElementById('confirm-ok-btn'),
                    cancelBtn: document.getElementById('confirm-cancel-btn'),
                },
                printInvoiceBtn: document.getElementById('print-invoice-btn'),
            };

            // --- 4. UTILITY & HELPER FUNCTIONS ---
            
            // Log user activity to Firestore
            const logActivity = async (message) => {
                if (!isAuthReady) return;
                try {
                    await addDoc(collections.activities, {
                        message,
                        timestamp: serverTimestamp(),
                        userId: userId, // Keep userId for tracking
                    });
                } catch (error) {
                    console.error("Error logging activity:", error);
                }
            };

            // Open a modal with transition
            const openModal = (modalEl) => {
                currentOpenModal = modalEl;
                modalEl.classList.remove('pointer-events-none');
                modalEl.classList.add('opacity-100');
                modalEl.querySelector('.modal-content').classList.remove('opacity-0', '-translate-y-10');
                modalEl.querySelector('.modal-content').classList.add('opacity-100', 'translate-y-0');
            };

            // Close the currently open modal
            const closeModal = () => {
                if (!currentOpenModal) return;
                const modalToClose = currentOpenModal;
                currentOpenModal = null;
                modalToClose.classList.remove('opacity-100');
                modalToClose.classList.add('pointer-events-none');
                modalToClose.querySelector('.modal-content').classList.remove('opacity-100', 'translate-y-0');
                modalToClose.querySelector('.modal-content').classList.add('opacity-0', '-translate-y-10');
            };

            // Open confirmation dialog
            const openConfirmModal = (title, body, onConfirm) => {
                DOMElements.confirmModal.title.textContent = title;
                DOMElements.confirmModal.body.textContent = body;
                currentDeleteAction = onConfirm;
                openModal(DOMElements.confirmModal.el);
            };

            // Format numbers to currency string
            const formatCurrency = (amount) => `$${new Intl.NumberFormat().format(amount || 0)}`;

            // --- 5. NAVIGATION & UI ---

            // Switch between main content tabs
            const switchTab = (targetId) => {
                DOMElements.contentSections.forEach(s => s.classList.toggle('hidden', s.id !== targetId));
                
                const titles = {'dashboard-content': 'å„€è¡¨æ¿', 'customers-content': 'å®¢æˆ¶ç®¡ç†', 'projects-content': 'å°ˆæ¡ˆç®¡ç†', 'calendar-content': 'è¡Œäº‹æ›†', 'billing-content': 'å¸³å‹™ç®¡ç†', 'reports-content': 'å ±è¡¨åˆ†æ', 'settings-content': 'è¨­å®š'};
                DOMElements.mainHeader.textContent = titles[targetId];

                Object.values(DOMElements.actionButtons).forEach(btn => btn.classList.add('hidden'));
                if (targetId === 'customers-content') DOMElements.actionButtons.customer.classList.remove('hidden');
                if (targetId === 'projects-content') DOMElements.actionButtons.project.classList.remove('hidden');
                if (targetId === 'billing-content') DOMElements.actionButtons.billing.classList.remove('hidden');

                DOMElements.navLinks.forEach(n => {
                    const isActive = n.dataset.target === targetId;
                    n.classList.toggle('bg-wine-100', isActive);
                    n.classList.toggle('text-wine-800', isActive);
                    n.classList.toggle('text-slate-600', !isActive);
                });

                if (targetId === 'reports-content') renderCharts();
            };

            // --- 6. DATA LISTENERS & RENDERING ---
            
            function initDataListeners() {
                if (!isAuthReady) {
                    console.log("Auth not ready, skipping listeners.");
                    return;
                }

                // Customer data listener
                onSnapshot(query(collections.customers, orderBy('createdAt', 'desc')), (snapshot) => {
                    const listBody = DOMElements.customerListBody;
                    const countEl = document.getElementById('customer-count');
                    const dashboardCountEl = document.getElementById('dashboard-customer-count');
                    
                    listBody.innerHTML = '';
                    if (snapshot.empty) {
                        listBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-500">å°šç„¡å®¢æˆ¶è³‡æ–™ï¼Œé»æ“Šå³ä¸Šè§’ã€Œæ–°å¢å®¢æˆ¶ã€é–‹å§‹</td></tr>`;
                        countEl.textContent = 'ç¸½å…±æ‰¾åˆ° 0 ä½å®¢æˆ¶';
                        dashboardCountEl.textContent = '0';
                        return;
                    }

                    countEl.textContent = `ç¸½å…±æ‰¾åˆ° ${snapshot.size} ä½å®¢æˆ¶`;
                    dashboardCountEl.textContent = snapshot.size;

                    snapshot.forEach(doc => {
                        const customer = doc.data();
                        const id = doc.id;
                        const row = document.createElement('tr');
                        row.className = 'bg-white border-b hover:bg-slate-50';
                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium text-slate-900 whitespace-nowrap"><div class="font-bold">${customer.companyName}</div><div class="text-xs text-slate-500">çµ±ç·¨: ${customer.taxId || 'N/A'}</div></td>
                            <td class="px-6 py-4">${customer.contactPerson}</td>
                            <td class="px-6 py-4">${customer.phone || 'N/A'}</td>
                            <td class="px-6 py-4"><div class="truncate-text" title="${customer.address || ''}">${customer.address || 'N/A'}</div></td>
                            <td class="px-6 py-4"><div class="truncate-text" title="${customer.notes || ''}">${customer.notes || 'N/A'}</div></td>
                            <td class="px-6 py-4 text-center space-x-2">
                                <button data-id="${id}" class="edit-customer-btn font-medium text-wine-700 hover:underline">ç·¨è¼¯</button>
                                <button data-id="${id}" class="delete-customer-btn font-medium text-slate-500 hover:underline">åˆªé™¤</button>
                            </td>`;
                        listBody.appendChild(row);
                    });
                });

                // Project data listener
                onSnapshot(query(collections.projects, orderBy('createdAt', 'desc')), (snapshot) => {
                    const { planning, inprogress, completed } = DOMElements.kanban;
                    planning.innerHTML = ''; inprogress.innerHTML = ''; completed.innerHTML = '';
                    let inProgressCount = 0;
                    
                    snapshot.forEach(doc => {
                        const project = doc.data();
                        const id = doc.id;
                        const card = document.createElement('div');
                        card.className = 'bg-white p-4 rounded-lg shadow-sm border cursor-pointer hover:shadow-md transition-shadow';
                        card.dataset.id = id;
                        card.innerHTML = `
                            <h4 class="font-bold text-slate-800">${project.projectName}</h4>
                            <p class="text-sm text-slate-600 mt-1">${project.customerName || 'æœªæŒ‡å®šå®¢æˆ¶'}</p>
                            <div class="text-xs text-slate-500 mt-3 flex justify-between items-center">
                                <span>æˆªæ­¢æ—¥æœŸ: ${project.deadline || 'N/A'}</span>
                                <span class="font-semibold">${project.status}</span>
                            </div>`;
                        card.addEventListener('click', () => handleOpenProjectModal('edit', doc));
                        
                        if (project.status === 'é€²è¡Œä¸­') {
                            inprogress.appendChild(card);
                            inProgressCount++;
                        } else if (project.status === 'å·²å®Œæˆ') {
                            completed.appendChild(card);
                        } else {
                            planning.appendChild(card);
                        }
                    });
                    document.getElementById('dashboard-project-count').textContent = inProgressCount;
                     if (planning.innerHTML === '') planning.innerHTML = `<p class="text-center text-slate-500 p-4">ç„¡è¦åŠƒä¸­å°ˆæ¡ˆ</p>`;
                    if (inprogress.innerHTML === '') inprogress.innerHTML = `<p class="text-center text-slate-500 p-4">ç„¡é€²è¡Œä¸­å°ˆæ¡ˆ</p>`;
                    if (completed.innerHTML === '') completed.innerHTML = `<p class="text-center text-slate-500 p-4">ç„¡å·²å®Œæˆå°ˆæ¡ˆ</p>`;
                });

                // Invoice data listener
                onSnapshot(query(collections.invoices, orderBy('issueDate', 'desc')), (snapshot) => {
                    const invoiceListBody = DOMElements.invoiceListBody;
                    invoiceListBody.innerHTML = '';
                    let totalRevenue = 0, paidAmount = 0, unpaidAmount = 0;

                    if (snapshot.empty) {
                        invoiceListBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-500">å°šç„¡å¸³å‹™è³‡æ–™</td></tr>`;
                    } else {
                        document.getElementById('invoice-count').textContent = `ç¸½å…±æ‰¾åˆ° ${snapshot.size} ç­†è³‡æ–™`;
                        snapshot.forEach(doc => {
                            const invoice = doc.data(); const id = doc.id;
                            let statusBadge;
                            const amount = invoice.totalAmount || 0;
                            
                            switch(invoice.status) {
                                case 'å·²ä»˜æ¬¾': 
                                    statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-green-800 bg-green-100 rounded-full">å·²ä»˜æ¬¾</span>`; 
                                    paidAmount += amount; 
                                    break;
                                case 'å·²å‚³é€': 
                                    statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-blue-800 bg-blue-100 rounded-full">å·²å‚³é€</span>`; 
                                    unpaidAmount += amount; 
                                    break;
                                case 'å·²é€¾æœŸ': 
                                    statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-red-800 bg-red-100 rounded-full">å·²é€¾æœŸ</span>`; 
                                    unpaidAmount += amount; 
                                    break;
                                default: 
                                    statusBadge = `<span class="px-2 py-1 text-xs font-semibold text-slate-800 bg-slate-200 rounded-full">è‰ç¨¿</span>`; 
                                    break;
                            }
                            if(invoice.status !== 'è‰ç¨¿') { totalRevenue += amount; }
                            const row = document.createElement('tr');
                            row.className = 'bg-white border-b hover:bg-slate-50';
                            row.innerHTML = `
                                <td class="px-6 py-4 font-bold text-wine-800">${invoice.invoiceNumber || 'N/A'}</td>
                                <td class="px-6 py-4 font-medium text-slate-900"><div class="font-bold">${invoice.customerName || 'N/A'}</div><div class="text-xs text-slate-500">${invoice.projectName || ''}</div></td>
                                <td class="px-6 py-4"><div class="font-medium">é–‹ç«‹: ${invoice.issueDate || 'N/A'}</div><div class="text-xs text-slate-500">çµæ¡ˆ: ${invoice.closeDate || ''}</div></td>
                                <td class="px-6 py-4 font-semibold">${formatCurrency(amount)}</td>
                                <td class="px-6 py-4">${statusBadge}</td>
                                <td class="px-6 py-4 text-center space-x-2">
                                    <button data-id="${id}" class="view-invoice-btn font-medium text-blue-600 hover:underline">æŸ¥çœ‹</button>
                                    <button data-id="${id}" class="edit-invoice-btn font-medium text-wine-700 hover:underline">ç·¨è¼¯</button>
                                    <button data-id="${id}" class="delete-invoice-btn font-medium text-slate-500 hover:underline">åˆªé™¤</button>
                                </td>`;
                            invoiceListBody.appendChild(row);
                        });
                    }
                    document.getElementById('dashboard-revenue').textContent = formatCurrency(totalRevenue);
                    document.getElementById('dashboard-paid').textContent = formatCurrency(paidAmount);
                    document.getElementById('dashboard-unpaid').textContent = formatCurrency(unpaidAmount);
                });

                // CORRECTED: Activity log listener for global activities
                onSnapshot(query(collections.activities, orderBy('timestamp', 'desc')), (snapshot) => {
                    const logEl = document.getElementById('activity-log');
                    logEl.innerHTML = '';
                    if (snapshot.empty) {
                        logEl.innerHTML = `<li class="text-center p-4 text-slate-500">å°šç„¡å‹•æ…‹</li>`;
                        return;
                    }
                    snapshot.forEach(doc => {
                        const log = doc.data();
                        const time = log.timestamp ? log.timestamp.toDate().toLocaleString('zh-TW', { dateStyle: 'short', timeStyle: 'short' }) : 'N/A';
                        const userDisplay = log.userId ? ` by <span class="font-medium text-slate-600" title="${log.userId}">user ${log.userId.substring(0, 6)}...</span>` : '';
                        const li = document.createElement('li');
                        li.className = 'border-b pb-2 last:border-b-0';
                        li.innerHTML = `<p class="text-slate-700">${log.message}</p><p class="text-sm text-slate-500">${time}${userDisplay}</p>`;
                        logEl.appendChild(li);
                    });
                });
            }

            // --- 7. MODAL HANDLING & CRUD OPERATIONS ---

            // Customer Modal
            const handleOpenCustomerModal = async (mode, docId = null) => {
                const { el, title, form, submitBtn } = DOMElements.customerModal;
                form.reset();
                form.customerId.value = '';
                if (mode === 'add') {
                    title.textContent = 'æ–°å¢å®¢æˆ¶';
                    submitBtn.textContent = 'å„²å­˜å®¢æˆ¶';
                } else {
                    title.textContent = 'ç·¨è¼¯å®¢æˆ¶è³‡æ–™';
                    submitBtn.textContent = 'æ›´æ–°å®¢æˆ¶';
                    if (docId) {
                        const docSnap = await getDoc(doc(collections.customers, docId));
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            form.customerId.value = docId;
                            form.companyName.value = data.companyName || '';
                            form.taxId.value = data.taxId || '';
                            form.contactPerson.value = data.contactPerson || '';
                            form.phone.value = data.phone || '';
                            form.fax.value = data.fax || '';
                            form.email.value = data.email || '';
                            form.address.value = data.address || '';
                            form.notes.value = data.notes || '';
                        }
                    }
                }
                openModal(el);
            };

            const handleSaveCustomer = async (e) => {
                e.preventDefault();
                const form = DOMElements.customerModal.form;
                const id = form.customerId.value;
                const data = {
                    companyName: form.companyName.value,
                    taxId: form.taxId.value,
                    contactPerson: form.contactPerson.value,
                    phone: form.phone.value,
                    fax: form.fax.value,
                    email: form.email.value,
                    address: form.address.value,
                    notes: form.notes.value,
                    updatedAt: serverTimestamp(),
                };

                try {
                    if (id) { // Update existing
                        await updateDoc(doc(collections.customers, id), data);
                        logActivity(`æ›´æ–°äº†å®¢æˆ¶è³‡æ–™ï¼š${data.companyName}`);
                    } else { // Add new
                        data.createdAt = serverTimestamp();
                        await addDoc(collections.customers, data);
                        logActivity(`æ–°å¢äº†å®¢æˆ¶ï¼š${data.companyName}`);
                    }
                    closeModal();
                } catch (error) {
                    console.error("Error saving customer: ", error);
                    alert("å„²å­˜å®¢æˆ¶å¤±æ•—ï¼");
                }
            };
            
            const handleDeleteCustomer = async (id) => {
                if (!id) return;
                const docRef = doc(collections.customers, id);
                const docSnap = await getDoc(docRef);
                const customerName = docSnap.exists() ? docSnap.data().companyName : 'è©²å®¢æˆ¶';

                openConfirmModal('ç¢ºèªåˆªé™¤å®¢æˆ¶', `æ‚¨ç¢ºå®šè¦åˆªé™¤ã€Œ${customerName}ã€å—ï¼Ÿç›¸é—œçš„å°ˆæ¡ˆå’Œå¸³å‹™è³‡æ–™å°‡ä¸æœƒè¢«åˆªé™¤ï¼Œä½†å¯èƒ½æœƒå¤±å»é—œè¯ã€‚`, async () => {
                    try {
                        await deleteDoc(docRef);
                        logActivity(`åˆªé™¤äº†å®¢æˆ¶ï¼š${customerName}`);
                        closeModal(); // Close confirm modal
                    } catch (error) {
                        console.error("Error deleting customer: ", error);
                    }
                });
            };

            // Project Modal
             const handleOpenProjectModal = async (mode, projectDoc = null) => {
                const { el, title, form, submitBtn } = DOMElements.projectModal;
                form.reset();
                form.projectId.value = '';
                const customerSelect = form.projectCustomer;
                await populateDropdown(customerSelect, collections.customers, 'companyName');
                
                if (mode === 'add') {
                    title.textContent = 'æ–°å¢å°ˆæ¡ˆ';
                    submitBtn.textContent = 'å„²å­˜å°ˆæ¡ˆ';
                } else {
                    title.textContent = 'ç·¨è¼¯å°ˆæ¡ˆ';
                    submitBtn.textContent = 'æ›´æ–°å°ˆæ¡ˆ';
                    if (projectDoc) {
                        const data = projectDoc.data();
                        form.projectId.value = projectDoc.id;
                        form.projectName.value = data.projectName || '';
                        form.projectCustomer.value = data.customerId || '';
                        form.projectDeadline.value = data.deadline || '';
                        form.projectStatus.value = data.status || 'è¦åŠƒä¸­';
                    }
                }
                openModal(el);
            };

            const handleSaveProject = async (e) => {
                e.preventDefault();
                const form = DOMElements.projectModal.form;
                const id = form.projectId.value;
                const customerSelect = form.projectCustomer;
                const selectedOption = customerSelect.options[customerSelect.selectedIndex];

                const data = {
                    projectName: form.projectName.value,
                    customerId: customerSelect.value,
                    customerName: selectedOption.dataset.name || 'N/A',
                    deadline: form.projectDeadline.value,
                    status: form.projectStatus.value,
                    updatedAt: serverTimestamp(),
                };

                try {
                    if (id) {
                        await updateDoc(doc(collections.projects, id), data);
                        logActivity(`æ›´æ–°äº†å°ˆæ¡ˆï¼š${data.projectName}`);
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collections.projects, data);
                        logActivity(`æ–°å¢äº†å°ˆæ¡ˆï¼š${data.projectName}`);
                    }
                    closeModal();
                } catch (error) {
                    console.error("Error saving project:", error);
                }
            };
            
            // Invoice Modal
            const handleOpenInvoiceModal = async (mode, docId = null) => {
                const { el, title, form, submitBtn, footer } = DOMElements.invoiceModal;
                form.reset();
                document.getElementById('invoice-items-container').innerHTML = '';
                form.invoiceId.value = '';
                await populateDropdown(form.invoiceCustomer, collections.customers, 'companyName');
                form.invoiceProject.innerHTML = '<option value="">ç„¡é—œè¯å°ˆæ¡ˆ</option>';

                const isViewMode = mode === 'view';
                title.textContent = isViewMode ? 'æŸ¥çœ‹å¸³å–®' : (mode === 'add' ? 'æ–°å¢å¸³å‹™' : 'ç·¨è¼¯å¸³å‹™');
                submitBtn.textContent = mode === 'add' ? 'å„²å­˜å¸³å‹™' : 'æ›´æ–°å¸³å‹™';
                footer.style.display = isViewMode ? 'none' : 'flex';
                DOMElements.printInvoiceBtn.style.display = isViewMode ? 'block' : 'none';
                document.getElementById('add-invoice-item-btn').style.display = isViewMode ? 'none' : 'block';
                Array.from(form.elements).forEach(el => el.disabled = isViewMode);

                if (docId) {
                    const docSnap = await getDoc(doc(collections.invoices, docId));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        form.invoiceId.value = docId;
                        form.invoiceCustomer.value = data.customerId || '';
                        await populateDropdown(form.invoiceProject, collections.projects, 'projectName', where('customerId', '==', data.customerId));
                        form.invoiceProject.value = data.projectId || '';
                        form.invoiceNumber.value = data.invoiceNumber || '';
                        form.invoiceIssueDate.value = data.issueDate || '';
                        form.invoiceStatus.value = data.status || 'è‰ç¨¿';
                        form.invoiceCloseDate.value = data.closeDate || '';
                        (data.items || []).forEach(item => addInvoiceItem(item, isViewMode));
                        updateInvoiceTotal();
                    }
                } else { // Add mode
                     form.invoiceIssueDate.value = new Date().toISOString().split('T')[0];
                     addInvoiceItem({}, false);
                }
                openModal(el);
            };

            const handleSaveInvoice = async (e) => {
                e.preventDefault();
                const form = DOMElements.invoiceModal.form;
                const id = form.invoiceId.value;
                const customerSelect = form.invoiceCustomer;
                const projectSelect = form.invoiceProject;

                const items = Array.from(document.querySelectorAll('.invoice-item-row')).map(row => ({
                    description: row.querySelector('[name="itemDescription"]').value,
                    quantity: parseFloat(row.querySelector('[name="itemQuantity"]').value) || 0,
                    price: parseFloat(row.querySelector('[name="itemPrice"]').value) || 0,
                }));
                const totalAmount = items.reduce((sum, item) => sum + item.quantity * item.price, 0);

                const data = {
                    customerId: customerSelect.value,
                    customerName: customerSelect.options[customerSelect.selectedIndex]?.dataset.name || 'N/A',
                    projectId: projectSelect.value,
                    projectName: projectSelect.options[projectSelect.selectedIndex]?.dataset.name || '',
                    invoiceNumber: form.invoiceNumber.value,
                    issueDate: form.invoiceIssueDate.value,
                    status: form.invoiceStatus.value,
                    closeDate: form.invoiceStatus.value === 'å·²ä»˜æ¬¾' ? new Date().toISOString().split('T')[0] : (form.invoiceCloseDate.value || ''),
                    items: items,
                    totalAmount: totalAmount,
                    updatedAt: serverTimestamp(),
                };

                try {
                    if (id) {
                        await updateDoc(doc(collections.invoices, id), data);
                        logActivity(`æ›´æ–°äº†å¸³å–® #${data.invoiceNumber}`);
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collections.invoices, data);
                        logActivity(`æ–°å¢äº†å¸³å–® #${data.invoiceNumber}`);
                    }
                    closeModal();
                } catch (error) {
                    console.error("Error saving invoice: ", error);
                }
            };
            
            const handleDeleteInvoice = (id) => {
                 openConfirmModal('ç¢ºèªåˆªé™¤å¸³å–®', 'æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤å¸³å–®å—ï¼Ÿ', async () => {
                    try {
                        await deleteDoc(doc(collections.invoices, id));
                        logActivity(`åˆªé™¤äº†ä¸€ç­†å¸³å–®`);
                        closeModal(); // Close confirm modal
                    } catch (error) {
                        console.error("Error deleting invoice: ", error);
                    }
                });
            };

            // Event Modal
            const handleOpenEventModal = async (mode, data) => {
                 const { el, title, form, submitBtn, deleteBtn } = DOMElements.eventModal;
                 form.reset();
                 form.eventId.value = '';
                 deleteBtn.classList.add('hidden');
                 await populateDropdown(form.eventCustomer, collections.customers, 'companyName');
                 form.eventProject.innerHTML = '<option value="">ç„¡é—œè¯å°ˆæ¡ˆ</option>';

                 if (mode === 'add') {
                     title.textContent = 'æ–°å¢è¡Œäº‹æ›†äº‹ä»¶';
                     submitBtn.textContent = 'å„²å­˜';
                     form.eventDate.value = data; // data is date string
                 } else { // edit mode
                     title.textContent = 'ç·¨è¼¯è¡Œäº‹æ›†äº‹ä»¶';
                     submitBtn.textContent = 'æ›´æ–°';
                     deleteBtn.classList.remove('hidden');
                     deleteBtn.dataset.id = data.id;
                     form.eventId.value = data.id;
                     form.eventDate.value = data.date;
                     form.eventTitle.value = data.title || '';
                     form.eventNotes.value = data.notes || '';
                     if (data.customerId) {
                         form.eventCustomer.value = data.customerId;
                         await populateDropdown(form.eventProject, collections.projects, 'projectName', where('customerId', '==', data.customerId));
                         form.eventProject.value = data.projectId || '';
                     }
                 }
                 openModal(el);
            };

            const handleSaveEvent = async (e) => {
                e.preventDefault();
                const form = DOMElements.eventModal.form;
                const id = form.eventId.value;
                const customerSelect = form.eventCustomer;
                const projectSelect = form.eventProject;

                const data = {
                    date: form.eventDate.value,
                    title: form.eventTitle.value,
                    notes: form.eventNotes.value,
                    customerId: customerSelect.value,
                    customerName: customerSelect.options[customerSelect.selectedIndex]?.dataset.name || '',
                    projectId: projectSelect.value,
                    projectName: projectSelect.options[projectSelect.selectedIndex]?.dataset.name || '',
                    updatedAt: serverTimestamp(),
                };
                
                try {
                    if (id) {
                        await updateDoc(doc(collections.events, id), data);
                        logActivity(`æ›´æ–°äº†è¡Œäº‹æ›†äº‹ä»¶ï¼š${data.title}`);
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collections.events, data);
                        logActivity(`æ–°å¢äº†è¡Œäº‹æ›†äº‹ä»¶ï¼š${data.title}`);
                    }
                    closeModal();
                    renderCalendar(); // Re-render calendar
                } catch (error) {
                    console.error("Error saving event:", error);
                }
            };
            
            const handleDeleteEvent = async (id) => {
                if (!id) return;
                openConfirmModal('ç¢ºèªåˆªé™¤äº‹ä»¶', 'æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œäº‹æ›†äº‹ä»¶å—ï¼Ÿ', async () => {
                    try {
                        await deleteDoc(doc(collections.events, id));
                        logActivity(`åˆªé™¤äº†ä¸€ç­†è¡Œäº‹æ›†äº‹ä»¶`);
                        closeModal(); // Close confirm modal
                        renderCalendar();
                    } catch (error) {
                        console.error("Error deleting event: ", error);
                    }
                });
            };

            // --- 8. DYNAMIC UI HELPERS ---

            const addInvoiceItem = (item = {}, isViewMode = false) => {
                const container = document.getElementById('invoice-items-container');
                const itemRow = document.createElement('div');
                itemRow.className = 'invoice-item-row grid grid-cols-12 gap-2 items-center';
                itemRow.innerHTML = `
                    <div class="col-span-6"><input name="itemDescription" type="text" placeholder="æœå‹™å…§å®¹æè¿°" class="w-full text-sm form-input" value="${item.description || ''}" ${isViewMode ? 'disabled' : ''}></div>
                    <div class="col-span-2"><input name="itemQuantity" type="number" placeholder="æ•¸é‡" class="w-full text-sm form-input text-right" value="${item.quantity || 1}" ${isViewMode ? 'disabled' : ''}></div>
                    <div class="col-span-2"><input name="itemPrice" type="number" placeholder="å–®åƒ¹" class="w-full text-sm form-input text-right" value="${item.price || 0}" ${isViewMode ? 'disabled' : ''}></div>
                    <div class="col-span-1 text-right text-sm font-medium text-slate-700 item-total">$${((item.quantity || 0) * (item.price || 0)).toFixed(2)}</div>
                    <div class="col-span-1 text-right">
                        ${!isViewMode ? '<button type="button" class="remove-invoice-item-btn text-red-500 hover:text-red-700">&times;</button>' : ''}
                    </div>
                `;
                // Add styling to inputs
                itemRow.querySelectorAll('input').forEach(input => {
                    input.classList.add('px-2', 'py-1', 'bg-white', 'border', 'border-slate-300', 'rounded-md', 'shadow-sm', 'focus:outline-none', 'focus:ring-wine-500', 'focus:border-wine-500');
                    if (isViewMode) {
                        input.classList.add('bg-slate-50', 'cursor-not-allowed');
                    }
                });
                container.appendChild(itemRow);
            };

            const updateInvoiceTotal = () => {
                const total = Array.from(document.querySelectorAll('.invoice-item-row')).reduce((sum, row) => {
                    const quantity = parseFloat(row.querySelector('[name="itemQuantity"]').value) || 0;
                    const price = parseFloat(row.querySelector('[name="itemPrice"]').value) || 0;
                    const itemTotal = quantity * price;
                    row.querySelector('.item-total').textContent = formatCurrency(itemTotal);
                    return sum + itemTotal;
                }, 0);
                document.getElementById('invoice-total-amount').textContent = formatCurrency(total);
            };
            
            // Generic function to populate a <select> dropdown from a collection
            async function populateDropdown(selectElement, collectionRef, textField, ...queryConstraints) {
                selectElement.innerHTML = `<option value="">è«‹é¸æ“‡</option>`;
                const q = query(collectionRef, orderBy(textField), ...queryConstraints);
                const snapshot = await getDocs(q);
                snapshot.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = doc.data()[textField];
                    option.dataset.name = doc.data()[textField];
                    selectElement.appendChild(option);
                });
            }


            // --- 9. CALENDAR & CHARTS ---
            
            // Calendar
            async function renderCalendar() {
                if(!isAuthReady) return;
                const calendarGrid = document.getElementById('calendar-grid');
                const monthYearHeader = document.getElementById('month-year-header');
                calendarGrid.innerHTML = '';
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                monthYearHeader.textContent = `${year}å¹´ ${month + 1}æœˆ`;

                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const startDay = firstDayOfMonth.getDay();
                const totalDays = lastDayOfMonth.getDate();
                
                const startOfMonthStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
                const endOfMonthStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(totalDays).padStart(2, '0')}`;
                
                const eventsSnapshot = await getDocs(query(collections.events, where('date', '>=', startOfMonthStr), where('date', '<=', endOfMonthStr)));
                const eventsMap = new Map();
                eventsSnapshot.forEach(doc => {
                    const event = doc.data();
                    if (!eventsMap.has(event.date)) eventsMap.set(event.date, []);
                    eventsMap.get(event.date).push({ id: doc.id, ...event });
                });

                for (let i = 0; i < startDay; i++) calendarGrid.insertAdjacentHTML('beforeend', '<div></div>');
                
                for (let day = 1; day <= totalDays; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayEl = document.createElement('div');
                    dayEl.className = 'calendar-day p-2 bg-white border-t border-l border-slate-200 cursor-pointer relative';
                    dayEl.dataset.date = dateStr;
                    
                    let dayNumberClass = "text-sm";
                    const today = new Date();
                    if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
                        dayNumberClass += ' bg-wine-800 text-white rounded-full w-6 h-6 flex items-center justify-center';
                    }
                    dayEl.innerHTML = `<div class="${dayNumberClass}">${day}</div><div class="events-container mt-1 space-y-1 overflow-hidden"></div>`;
                    
                    if (eventsMap.has(dateStr)) {
                        const eventsContainer = dayEl.querySelector('.events-container');
                        eventsMap.get(dateStr).forEach(event => {
                            const eventEl = document.createElement('div');
                            eventEl.className = 'text-xs bg-blue-100 text-blue-800 rounded px-1 truncate hover:bg-blue-200';
                            eventEl.textContent = event.title;
                            eventEl.title = event.title;
                            eventEl.addEventListener('click', (e) => { e.stopPropagation(); handleOpenEventModal('edit', event); });
                            eventsContainer.appendChild(eventEl);
                        });
                    }
                    dayEl.addEventListener('click', () => handleOpenEventModal('add', dateStr));
                    calendarGrid.appendChild(dayEl);
                }
            }
            
            // Charts
            async function renderCharts() {
                if (!isAuthReady) return;
                if (revenueChart) revenueChart.destroy();
                if (customerChart) customerChart.destroy();
                if (projectChart) projectChart.destroy();

                const invoiceSnapshot = await getDocs(query(collections.invoices, where('status', '!=', 'è‰ç¨¿')));
                const projectSnapshot = await getDocs(collections.projects);

                const monthlyRevenue = {};
                const customerContribution = {};
                invoiceSnapshot.forEach(doc => {
                    const invoice = doc.data();
                    if (!invoice.issueDate) return;
                    const month = invoice.issueDate.substring(0, 7);
                    monthlyRevenue[month] = (monthlyRevenue[month] || 0) + invoice.totalAmount;
                    customerContribution[invoice.customerName] = (customerContribution[invoice.customerName] || 0) + invoice.totalAmount;
                });

                const projectStatusCounts = { 'è¦åŠƒä¸­': 0, 'é€²è¡Œä¸­': 0, 'å·²å®Œæˆ': 0 };
                projectSnapshot.forEach(doc => {
                    const status = doc.data().status || 'è¦åŠƒä¸­';
                    projectStatusCounts[status]++;
                });

                renderRevenueChart(monthlyRevenue);
                renderCustomerChart(customerContribution);
                renderProjectStatusChart(projectStatusCounts);
            }
            function renderRevenueChart(data) {
                const ctx = document.getElementById('revenue-chart')?.getContext('2d');
                if(!ctx) return;
                const labels = Object.keys(data).sort();
                const values = labels.map(label => data[label]);
                revenueChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'æ¯æœˆç‡Ÿæ¥­é¡', data: values, backgroundColor: 'rgba(153, 27, 27, 0.6)', borderColor: 'rgba(153, 27, 27, 1)', borderWidth: 1 }] }, options: { scales: { y: { beginAtZero: true } } } });
            }
            function renderCustomerChart(data) {
                const ctx = document.getElementById('customer-contribution-chart')?.getContext('2d');
                if(!ctx) return;
                const labels = Object.keys(data);
                const values = Object.values(data);
                customerChart = new Chart(ctx, { type: 'doughnut', data: { labels, datasets: [{ label: 'å®¢æˆ¶è²¢ç»', data: values, backgroundColor: [ 'rgba(153, 27, 27, 0.7)', 'rgba(220, 38, 38, 0.7)', 'rgba(248, 113, 113, 0.7)', 'rgba(252, 165, 165, 0.7)', 'rgba(254, 202, 202, 0.7)' ], hoverOffset: 4 }] } });
            }
            function renderProjectStatusChart(data) {
                const ctx = document.getElementById('project-status-chart')?.getContext('2d');
                if(!ctx) return;
                const labels = Object.keys(data);
                const values = Object.values(data);
                projectChart = new Chart(ctx, { type: 'pie', data: { labels, datasets: [{ label: 'å°ˆæ¡ˆç‹€æ…‹', data: values, backgroundColor: [ 'rgba(59, 130, 246, 0.7)', 'rgba(234, 179, 8, 0.7)', 'rgba(34, 197, 94, 0.7)' ], hoverOffset: 4 }] } });
            }


            // --- 10. EVENT LISTENERS ---
            function initEventListeners() {
                // Main Navigation
                DOMElements.navLinks.forEach(link => link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab(link.dataset.target);
                }));

                // Header Action Buttons
                DOMElements.addCustomerBtn.addEventListener('click', () => handleOpenCustomerModal('add'));
                DOMElements.addProjectBtn.addEventListener('click', () => handleOpenProjectModal('add'));
                DOMElements.addInvoiceBtn.addEventListener('click', () => handleOpenInvoiceModal('add'));

                // Modal Close/Cancel Buttons
                document.querySelectorAll('.modal-close-btn, .modal-cancel-btn').forEach(btn => {
                    btn.addEventListener('click', closeModal);
                });

                // Form Submissions
                DOMElements.customerModal.form.addEventListener('submit', handleSaveCustomer);
                DOMElements.projectModal.form.addEventListener('submit', handleSaveProject);
                DOMElements.invoiceModal.form.addEventListener('submit', handleSaveInvoice);
                DOMElements.eventModal.form.addEventListener('submit', handleSaveEvent);

                // Event delegation for dynamic buttons in lists
                DOMElements.customerListBody.addEventListener('click', e => {
                    if (e.target.classList.contains('edit-customer-btn')) handleOpenCustomerModal('edit', e.target.dataset.id);
                    if (e.target.classList.contains('delete-customer-btn')) handleDeleteCustomer(e.target.dataset.id);
                });
                DOMElements.invoiceListBody.addEventListener('click', e => {
                    if (e.target.classList.contains('edit-invoice-btn')) handleOpenInvoiceModal('edit', e.target.dataset.id);
                    if (e.target.classList.contains('view-invoice-btn')) handleOpenInvoiceModal('view', e.target.dataset.id);
                    if (e.target.classList.contains('delete-invoice-btn')) handleDeleteInvoice(e.target.dataset.id);
                });

                // Invoice Item Management
                document.getElementById('add-invoice-item-btn').addEventListener('click', () => addInvoiceItem());
                document.getElementById('invoice-items-container').addEventListener('click', e => {
                    if (e.target.classList.contains('remove-invoice-item-btn')) e.target.closest('.invoice-item-row').remove();
                });
                document.getElementById('invoice-form').addEventListener('input', e => {
                    if (e.target.name === 'itemQuantity' || e.target.name === 'itemPrice') updateInvoiceTotal();
                });
                 document.getElementById('invoice-form').addEventListener('change', async e => {
                    if (e.target.id === 'invoiceCustomer' && e.target.value) {
                       await populateDropdown(document.getElementById('invoiceProject'), collections.projects, 'projectName', where('customerId', '==', e.target.value));
                    }
                    if (e.target.id === 'invoiceStatus' && e.target.value === 'å·²ä»˜æ¬¾') {
                        document.getElementById('invoiceCloseDate').value = new Date().toISOString().split('T')[0];
                    }
                });

                // Event Modal Management
                 DOMElements.eventModal.deleteBtn.addEventListener('click', (e) => handleDeleteEvent(e.target.dataset.id));
                 document.getElementById('event-form').addEventListener('change', async e => {
                    if (e.target.id === 'eventCustomer' && e.target.value) {
                       await populateDropdown(document.getElementById('eventProject'), collections.projects, 'projectName', where('customerId', '==', e.target.value));
                    }
                 });


                // Confirmation Modal Buttons
                DOMElements.confirmModal.okBtn.addEventListener('click', () => {
                    if (typeof currentDeleteAction === 'function') {
                        currentDeleteAction();
                    }
                    currentDeleteAction = null;
                });
                DOMElements.confirmModal.cancelBtn.addEventListener('click', closeModal);
                
                // Calendar Navigation
                document.getElementById('prev-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); });
                document.getElementById('next-month-btn').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); });

                // Print Invoice
                DOMElements.printInvoiceBtn.addEventListener('click', () => window.print());
            }

            // --- 11. INITIALIZATION ---
            initEventListeners();
            switchTab('dashboard-content');
        });
    </script>
</body>
</html>
